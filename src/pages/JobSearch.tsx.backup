import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { Search, MapPin, DollarSign, Bookmark, ArrowRight, BookmarkCheck } from 'lucide-react'
import { apiCall } from '../utils/api'

// 날짜 차이 계산 함수
const getDaysAgo = (dateString: string): string => {
  const today = new Date()
  const postedDate = new Date(dateString)
  const diffTime = today.getTime() - postedDate.getTime()
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
  
  if (diffDays === 0) return '오늘'
  if (diffDays === 1) return '1일전'
  if (diffDays < 7) return `${diffDays}일전`
  if (diffDays < 30) return `${Math.floor(diffDays / 7)}주전`
  return `${Math.floor(diffDays / 30)}개월전`
}

// 직업 카테고리 데이터
const jobCategories = [
  '기획·전략',
  '마케팅·홍보·조사',
  '회계·세무·재무',
  '인사·노무·HRD',
  '총무·법무·사무',
  'IT개발·데이터',
  '디자인',
  '영업·판매·무역',
  '고객상담·TM',
  '구매·자재·물류',
  '상품기획·MD',
  '운전·운송·배송',
  '서비스',
  '생산',
  '건설·건축',
  '의료',
  '연구·R&D',
  '교육',
  '미디어·문화·스포츠',
  '금융·보험',
  '공공·복지'
]

// 시/도 데이터
const regions: Record<string, string[]> = {
  '서울': ['강남구', '강동구', '강북구', '강서구', '관악구', '광진구', '구로구', '금천구', '노원구', '도봉구', '동대문구', '동작구', '마포구', '서대문구', '서초구', '성동구', '성북구', '송파구', '양천구', '영등포구', '용산구', '은평구', '종로구', '중구', '중랑구'],
  '부산': ['강서구', '금정구', '기장군', '남구', '동구', '동래구', '부산진구', '북구', '사상구', '사하구', '서구', '수영구', '연제구', '영도구', '중구', '해운대구'],
  '대구': ['남구', '달서구', '달성군', '동구', '북구', '서구', '수성구', '중구'],
  '인천': ['강화군', '계양구', '미추홀구', '남동구', '동구', '부평구', '서구', '연수구', '옹진군', '중구'],
  '광주': ['광산구', '남구', '동구', '북구', '서구'],
  '대전': ['대덕구', '동구', '서구', '유성구', '중구'],
  '울산': ['남구', '동구', '북구', '울주군', '중구'],
  '세종': ['세종시'],
  '경기': ['가평군', '고양시', '과천시', '광명시', '광주시', '구리시', '군포시', '김포시', '남양주시', '동두천시', '부천시', '성남시', '수원시', '시흥시', '안산시', '안성시', '안양시', '양주시', '양평군', '여주시', '연천군', '오산시', '용인시', '의왕시', '의정부시', '이천시', '파주시', '평택시', '포천시', '하남시', '화성시'],
  '강원': ['강릉시', '고성군', '동해시', '삼척시', '속초시', '양구군', '양양군', '영월군', '원주시', '인제군', '정선군', '철원군', '춘천시', '태백시', '평창군', '홍천군', '화천군', '횡성군'],
  '충북': ['괴산군', '단양군', '보은군', '영동군', '옥천군', '음성군', '제천시', '증평군', '진천군', '청주시', '충주시'],
  '충남': ['계룡시', '공주시', '금산군', '논산시', '당진시', '보령시', '부여군', '서산시', '서천군', '아산시', '예산군', '천안시', '청양군', '태안군', '홍성군'],
  '전북': ['고창군', '군산시', '김제시', '남원시', '무주군', '부안군', '순창군', '완주군', '익산시', '임실군', '장수군', '전주시', '정읍시', '진안군'],
  '전남': ['강진군', '고흥군', '곡성군', '광양시', '구례군', '나주시', '담양군', '목포시', '무안군', '보성군', '순천시', '신안군', '여수시', '영광군', '영암군', '완도군', '장성군', '장흥군', '진도군', '함평군', '해남군', '화순군'],
  '경북': ['경산시', '경주시', '고령군', '구미시', '군위군', '김천시', '문경시', '봉화군', '상주시', '성주군', '안동시', '영덕군', '영양군', '영주시', '영천시', '예천군', '울릉군', '울진군', '의성군', '청도군', '청송군', '칠곡군', '포항시'],
  '경남': ['거제시', '거창군', '고성군', '김해시', '남해군', '밀양시', '사천시', '산청군', '양산시', '의령군', '진주시', '진해시', '창녕군', '창원시', '통영시', '하동군', '함안군', '함양군', '합천군'],
  '제주': ['서귀포시', '제주시']
}

function JobSearch() {
  const navigate = useNavigate()
  const [searchQuery, setSearchQuery] = useState('')
  const [savedJobIds, setSavedJobIds] = useState<number[]>([])
  const [jobs, setJobs] = useState<any[]>([])
  const [activeTab, setActiveTab] = useState<'job' | 'location' | 'search'>('job')
  const [selectedCategories, setSelectedCategories] = useState<string[]>([])
  const [selectedRegions, setSelectedRegions] = useState<string[]>([])
  const [selectedDistricts, setSelectedDistricts] = useState<string[]>([])
  const [categorySearchQuery, setCategorySearchQuery] = useState('')
  const [locationSearchQuery, setLocationSearchQuery] = useState('')

  // localStorage에서 저장된 일자리 ID 목록 불러오기
  useEffect(() => {
    const saved = localStorage.getItem('savedJobs')
    if (saved) {
      setSavedJobIds(JSON.parse(saved))
    }
  }, [])

  // 백엔드에서 활성 공고 불러오기
  useEffect(() => {
    const fetchActiveJobs = async () => {
      try {
        const response = await fetch('/api/jobs/active')
        
        if (response.ok) {
          const activeJobs = await response.json()
          
          const convertedJobs = activeJobs.map((job: any) => ({
            id: job.id,
            title: job.title,
            category: job.category || '',
            company: job.company || '',
            location: job.location || '',
            salary: job.salaryType && job.salary ? `${job.salaryType} ${job.salary}` : job.salary || '협의',
            description: job.description || '',
            type: '파트타임',
            posted: job.postedDate ? getDaysAgo(job.postedDate) : '최근',
            gender: job.gender || '무관',
            age: job.age || '무관',
            education: job.education || '무관'
          }))
          
          setJobs(convertedJobs)
        } else {
          setJobs([])
        }
      } catch (error) {
        console.error('Error fetching jobs:', error)
        setJobs([])
      }
    }

    fetchActiveJobs()
  }, [])

  // 일자리 저장/저장 해제
  const handleSaveJob = async (jobId: number) => {
    const userId = localStorage.getItem('userId')
    if (!userId) {
      alert('로그인이 필요합니다.')
      return
    }

    try {
      if (savedJobIds.includes(jobId)) {
        await apiCall(`/api/jobseeker/saved-jobs/${userId}/${jobId}`, { method: 'DELETE' })
        const updatedSavedJobs = savedJobIds.filter(id => id !== jobId)
        setSavedJobIds(updatedSavedJobs)
        localStorage.setItem('savedJobs', JSON.stringify(updatedSavedJobs))
        alert('저장이 해제되었습니다.')
      } else {
        await apiCall(`/api/jobseeker/saved-jobs/${userId}/${jobId}`, { method: 'POST' })
        const updatedSavedJobs = [...savedJobIds, jobId]
        setSavedJobIds(updatedSavedJobs)
        localStorage.setItem('savedJobs', JSON.stringify(updatedSavedJobs))
        alert('일자리가 저장되었습니다.')
      }
    } catch (error) {
      console.error('저장 처리 실패:', error)
      alert('저장 처리에 실패했습니다.')
    }
  }

  // 필터링된 일자리
  const filteredJobs = jobs.filter(job => {
    const matchesSearch = searchQuery === '' || 
      job.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      job.company.toLowerCase().includes(searchQuery.toLowerCase()) ||
      job.description.toLowerCase().includes(searchQuery.toLowerCase())
    
    let matchesLocation = true
    if (selectedRegions.length > 0 || selectedDistricts.length > 0) {
      if (selectedDistricts.length > 0) {
        matchesLocation = selectedDistricts.some(district => job.location.includes(district))
      } else {
        matchesLocation = selectedRegions.some(region => job.location.includes(region))
      }
    }
    
    const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(job.category)
    
    return matchesSearch && matchesLocation && matchesCategory
  })

  // 필터링된 카테고리
  const filteredCategories = jobCategories.filter(category => 
    categorySearchQuery === '' || category.includes(categorySearchQuery)
  )

  // 필터링된 지역
  const filteredRegions = Object.keys(regions).filter(region =>
    locationSearchQuery === '' || region.includes(locationSearchQuery)
  )

  return (
    <div>
      <h1 style={{ fontSize: '28px', fontWeight: 'bold', marginBottom: '24px' }}>구직 검색</h1>
      
      {/* 탭 메뉴 */}
      <div style={{ display: 'flex', border: '1px solid #e0e0e0', borderRadius: '8px 8px 0 0', overflow: 'hidden', marginBottom: 0 }}>
        <button
          onClick={() => setActiveTab('job')}
          style={{
            flex: 1,
            padding: '16px',
            border: 'none',
            borderRight: '1px solid #e0e0e0',
            backgroundColor: activeTab === 'job' ? '#ffffff' : '#f5f5f5',
            borderBottom: activeTab === 'job' ? 'none' : '1px solid #e0e0e0',
            cursor: 'pointer',
            fontSize: '16px',
            fontWeight: activeTab === 'job' ? 'bold' : 'normal',
            color: activeTab === 'job' ? '#2196f3' : '#666'
          }}
        >
          직업 선택
        </button>
        <button
          onClick={() => setActiveTab('location')}
          style={{
            flex: 1,
            padding: '16px',
            border: 'none',
            borderRight: '1px solid #e0e0e0',
            backgroundColor: activeTab === 'location' ? '#ffffff' : '#f5f5f5',
            borderBottom: activeTab === 'location' ? 'none' : '1px solid #e0e0e0',
            cursor: 'pointer',
            fontSize: '16px',
            fontWeight: activeTab === 'location' ? 'bold' : 'normal',
            color: activeTab === 'location' ? '#2196f3' : '#666'
          }}
        >
          지역 선택
        </button>
        <button
          onClick={() => setActiveTab('search')}
          style={{
            flex: 1,
            padding: '16px',
            border: 'none',
            backgroundColor: activeTab === 'search' ? '#ffffff' : '#f5f5f5',
            borderBottom: activeTab === 'search' ? 'none' : '1px solid #e0e0e0',
            cursor: 'pointer',
            fontSize: '16px',
            fontWeight: activeTab === 'search' ? 'bold' : 'normal',
            color: activeTab === 'search' ? '#2196f3' : '#666'
          }}
        >
          검색어 입력
        </button>
      </div>

      {/* 탭 내용 */}
      <div style={{ border: '1px solid #e0e0e0', borderTop: 'none', borderRadius: '0 0 8px 8px', padding: '24px', marginBottom: '24px', backgroundColor: '#ffffff' }}>
        {activeTab === 'job' && (
          <div>
            <input
              type="text"
              value={categorySearchQuery}
              onChange={(e) => setCategorySearchQuery(e.target.value)}
              placeholder="직업(직무) 또는 전문분야 입력"
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '1px solid #e0e0e0',
                borderRadius: '6px',
                fontSize: '14px',
                marginBottom: '16px'
              }}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '14px', color: '#666' }}>선택: {selectedCategories.length}개</span>
              <button
                onClick={() => setSelectedCategories([])}
                style={{
                  padding: '6px 12px',
                  border: '1px solid #e0e0e0',
                  borderRadius: '4px',
                  backgroundColor: '#ffffff',
                  cursor: 'pointer',
                  fontSize: '13px',
                  color: '#666'
                }}
              >
                초기화
              </button>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px' }}>
              {filteredCategories.map((category) => (
                <button
                  key={category}
                  onClick={() => {
                    if (selectedCategories.includes(category)) {
                      setSelectedCategories(selectedCategories.filter(c => c !== category))
                    } else {
                      setSelectedCategories([...selectedCategories, category])
                    }
                  }}
                  style={{
                    padding: '10px',
                    border: selectedCategories.includes(category) ? '2px solid #2196f3' : '1px solid #e0e0e0',
                    borderRadius: '6px',
                    backgroundColor: selectedCategories.includes(category) ? '#e3f2fd' : '#ffffff',
                    cursor: 'pointer',
                    fontSize: '13px',
                    color: selectedCategories.includes(category) ? '#2196f3' : '#333',
                    fontWeight: selectedCategories.includes(category) ? 'bold' : 'normal',
                    transition: 'all 0.2s',
                    textAlign: 'center'
                  }}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'location' && (
          <div>
            <input
              type="text"
              value={locationSearchQuery}
              onChange={(e) => setLocationSearchQuery(e.target.value)}
              placeholder="지역명 입력"
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '1px solid #e0e0e0',
                borderRadius: '6px',
                fontSize: '14px',
                marginBottom: '16px'
              }}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <span style={{ fontSize: '14px', color: '#666' }}>선택: {selectedRegions.length + selectedDistricts.length}개</span>
              <button
                onClick={() => {
                  setSelectedRegions([])
                  setSelectedDistricts([])
                }}
                style={{
                  padding: '6px 12px',
                  border: '1px solid #e0e0e0',
                  borderRadius: '4px',
                  backgroundColor: '#ffffff',
                  cursor: 'pointer',
                  fontSize: '13px',
                  color: '#666'
                }}
              >
                지역 초기화
              </button>
            </div>
            <div style={{ display: 'flex', gap: '16px' }}>
              {/* 시/도 목록 */}
              <div style={{ width: '150px', borderRight: '1px solid #e0e0e0', paddingRight: '16px' }}>
                <h3 style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '12px', color: '#333' }}>시/도</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', maxHeight: '400px', overflowY: 'auto' }}>
                  {filteredRegions.map((region) => (
                    <button
                      key={region}
                      onClick={() => {
                        if (selectedRegions.includes(region)) {
                          setSelectedRegions(selectedRegions.filter(r => r !== region))
                        } else {
                          setSelectedRegions([...selectedRegions, region])
                        }
                      }}
                      style={{
                        padding: '8px 12px',
                        border: 'none',
                        backgroundColor: selectedRegions.includes(region) ? '#e3f2fd' : 'transparent',
                        textAlign: 'left',
                        cursor: 'pointer',
                        fontSize: '13px',
                        color: selectedRegions.includes(region) ? '#2196f3' : '#333',
                        fontWeight: selectedRegions.includes(region) ? 'bold' : 'normal',
                        borderRadius: '4px',
                        transition: 'all 0.2s'
                      }}
                    >
                      {region}
                    </button>
                  ))}
                </div>
              </div>
              {/* 구/군 목록 */}
              <div style={{ flex: 1 }}>
                <h3 style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '12px', color: '#333' }}>구/군</h3>
                {selectedRegions.length === 0 ? (
                  <p style={{ fontSize: '13px', color: '#999', padding: '20px', textAlign: 'center' }}>
                    시/도를 먼저 선택하세요
                  </p>
                ) : (
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', maxHeight: '400px', overflowY: 'auto' }}>
                    {selectedRegions.map(region => 
                      regions[region]?.map((district) => (
                        <label
                          key={`${region}-${district}`}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px',
                            padding: '6px 10px',
                            cursor: 'pointer',
                            fontSize: '13px',
                            borderRadius: '4px',
                            backgroundColor: selectedDistricts.includes(district) ? '#e3f2fd' : '#fafafa',
                            border: selectedDistricts.includes(district) ? '1px solid #2196f3' : '1px solid #e0e0e0'
                          }}
                        >
                          <input
                            type="checkbox"
                            checked={selectedDistricts.includes(district)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedDistricts([...selectedDistricts, district])
                              } else {
                                setSelectedDistricts(selectedDistricts.filter(d => d !== district))
                              }
                            }}
                            style={{ width: '14px', height: '14px', cursor: 'pointer' }}
                          />
                          <span style={{ color: selectedDistricts.includes(district) ? '#2196f3' : '#333' }}>
                            {district}
                          </span>
                        </label>
                      ))
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'search' && (
          <div>
            <div style={{ marginBottom: '24px', position: 'relative' }}>
              <Search size={20} style={{ position: 'absolute', left: '16px', top: '50%', transform: 'translateY(-50%)', color: '#999' }} />
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="구직 제목, 기술 또는 회사 입력"
                style={{
                  width: '100%',
                  padding: '12px 16px 12px 48px',
                  border: '1px solid #e0e0e0',
                  borderRadius: '6px',
                  fontSize: '16px'
                }}
              />
            </div>
          </div>
        )}
      </div>

      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
        <div style={{ color: '#666', fontSize: '16px' }}>총 {filteredJobs.length}개의 일자리</div>
      </div>

      <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
        {filteredJobs.length === 0 ? (
          <div style={{
            padding: '48px',
            textAlign: 'center',
            backgroundColor: '#f9f9f9',
            borderRadius: '8px',
            border: '1px solid #e0e0e0'
          }}>
            <Search size={48} color="#999" style={{ marginBottom: '16px', opacity: 0.5 }} />
            <p style={{ fontSize: '16px', color: '#666', marginBottom: '8px' }}>검색 결과가 없습니다</p>
            <p style={{ fontSize: '14px', color: '#999' }}>다른 검색어나 지역을 선택해보세요.</p>
          </div>
        ) : (
          filteredJobs.map((job) => (
            <div
              key={job.id}
              style={{
                padding: '24px',
                border: '1px solid #e0e0e0',
                borderRadius: '8px',
                backgroundColor: '#ffffff'
              }}
            >
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                <div style={{ flex: 1 }}>
                  <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '8px' }}>{job.title}</h3>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                    <p style={{ color: '#666', fontSize: '14px', margin: 0 }}>{job.company}</p>
                    {job.category && (
                      <>
                        <span style={{ color: '#e0e0e0' }}>|</span>
                        <span style={{ color: '#2196f3', fontSize: '13px', fontWeight: '500' }}>
                          {job.category}
                        </span>
                      </>
                    )}
                  </div>
                  <div style={{ display: 'flex', gap: '16px', marginBottom: '12px', fontSize: '14px', color: '#666' }}>
                    <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <MapPin size={16} />
                      {job.location}
                    </span>
                    <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <DollarSign size={16} />
                      {job.salary}
                    </span>
                  </div>
                  <p style={{ color: '#666', fontSize: '14px', marginBottom: '12px' }}>{job.description}</p>
                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center', marginBottom: '8px', fontSize: '13px', color: '#666' }}>
                    <span>성별: <strong style={{ color: '#555' }}>{job.gender}</strong></span>
                    <span>연령: <strong style={{ color: '#555' }}>{job.age}</strong></span>
                    <span>학력: <strong style={{ color: '#555' }}>{job.education}</strong></span>
                  </div>
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <span style={{
                      padding: '4px 12px',
                      backgroundColor: '#e3f2fd',
                      color: '#2196f3',
                      borderRadius: '4px',
                      fontSize: '12px'
                    }}>{job.type}</span>
                    <span style={{ color: '#999', fontSize: '12px' }}>{job.posted}</span>
                  </div>
                </div>
              </div>
              <div style={{ display: 'flex', gap: '12px', marginTop: '16px' }}>
                <button
                  onClick={() => handleSaveJob(job.id)}
                  style={{
                    padding: '8px 16px',
                    border: savedJobIds.includes(job.id) ? '1px solid #2196f3' : '1px solid #e0e0e0',
                    borderRadius: '6px',
                    backgroundColor: savedJobIds.includes(job.id) ? '#e3f2fd' : '#ffffff',
                    color: savedJobIds.includes(job.id) ? '#2196f3' : '#333',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    transition: 'all 0.2s'
                  }}
                >
                  {savedJobIds.includes(job.id) ? (
                    <>
                      <BookmarkCheck size={16} />
                      저장됨
                    </>
                  ) : (
                    <>
                      <Bookmark size={16} />
                      저장
                    </>
                  )}
                </button>
                <button
                  onClick={() => navigate(`/jobseeker/job/${job.id}`)}
                  style={{
                    padding: '8px 16px',
                    border: 'none',
                    borderRadius: '6px',
                    backgroundColor: '#2196f3',
                    color: '#ffffff',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px'
                  }}
                >
                  상세보기
                  <ArrowRight size={16} />
                </button>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  )
}

export default JobSearch
